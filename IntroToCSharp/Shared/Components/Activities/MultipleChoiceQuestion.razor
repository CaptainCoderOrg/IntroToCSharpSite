@inject NavigationManager NavigationManager

<MudPaper Class="mt-4 pa-4" Elevation="5">
    <MudStack Justify="Justify.SpaceBetween" Row="true">
        <MudPaper Elevation="0">
            <MudText Typo="Typo.h6">@Question</MudText> 
        </MudPaper>
        <MudPaper Class="pa-2 border-solid border-2 mud-border-success" Style="@XPDisplayStyle" Elevation="0">
            <MudText Typo="Typo.body1"><b>XP: @Award</b></MudText>
        </MudPaper>
    </MudStack>
    <MudRadioGroup @bind-SelectedOption="@SelectedOption">
        <MudStack Class="mt-4">
            <CascadingValue Value="@this">
                @ChildContent
            </CascadingValue>
        </MudStack>
    </MudRadioGroup>

    @if (!_isSubmitted)
    {
        <MudButton Class="mt-4" OnClick="@Submit" Variant="Variant.Filled" Color="Color.Success">Submit</MudButton>
    }
    else
    {
        @if (_isWrong)
        {
            <MudText Class="mt-4">Your answer is incorrect.</MudText>
            <MudButton Class="mt-4" OnClick="@Reset" Variant="Variant.Filled" Color="Color.Error">Try Again</MudButton>
            <MudButton Class="mt-4" OnClick="@ShowAnswer" Variant="Variant.Filled" Color="Color.Warning">Show Answer</MudButton>
        }
        else
        {
            @if (!Explanation.Equals(""))
            {
                <MudExpansionPanels Class="mt-4">
                    <MudExpansionPanel Class="pl-4 pr-4" Style="@ExplanationStyle">
                        <TitleContent>
                            <MudText Typo="Typo.h5">Explanation</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudText Class="mt-4 pb-4">@Explanation</MudText>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

        }

    }
</MudPaper>

@code {
    /// <summary>
    /// Specifies if this question uses CheckBoxes (true) or RadioButtons (false). The
    /// default behavior is RadioButtons (false).
    /// </summary>
    /// <value></value>
    [Parameter]
    public bool IsMultiSelect { get; set; } = false;

    [Parameter]
    public string Question { get; set; } = "Undefined";

    [Parameter]
    public RenderFragment ChildContent { get; set; } = null!;
    [Parameter]
    public int XP { get; set; } = 30;
    public int Award => attempts >= 0 ? Math.Max(5, ((XP / (attempts+1))/5)*5) : 0;
    

    /// <summary>
    /// This is the explanation that appears after the user submits the question.
    /// If no explanation is given, no Explanation box appears after submission.
    /// </summary>
    /// <value></value>
    [Parameter]
    public string Explanation { get; set; } = "";

    private string SelectedOption { get; set; }
    private bool _isSubmitted = false;
    private bool _isWrong = false;
    private int attempts = 0;

    private string ExplanationStyle = $"background: #ffffe3; color: {Themes.s_CSharpTheme.Palette.Black.ToString()};";
    private string XPDisplayStyle = $"color: {Themes.s_CSharpTheme.Palette.Success.ToString()};";

    private List<CheckBoxOption> _options = new List<CheckBoxOption>();
    private string Path => $"{NavigationManager.GetRoute()}/questions/{Question}";
    private void Submit()
    {
        this._isSubmitted = true;
        if (!IsMultiSelect)
        {
            this._options.ForEach(option => option.IsChecked = this.SelectedOption == option.Text);
        }
        _isWrong = this._options.Where(option => !option.CheckAnswer()).Count() > 0;
        if(this.attempts != -1 && !_isWrong ) {
            UserService.Service.GiveXP(Award);
        } 
        // if the user hasn't selected "show answer", then...
        if(this.attempts != -1 ) {
            this.attempts++;
        }
        this.UpdateAndSave();
    }

    /// <summary>
    /// Adds the given CheckBoxOption to this question.
    /// </summary>
    /// <param name="child"></param>
    public void AddOption(CheckBoxOption child) => this._options.Add(child);

    /// <summary>
    /// Resets the question to the default state.
    /// </summary>
    private void Reset()
    {
        this._isSubmitted = false;
        this._options.ForEach(option => option.Reset());
    }

    /// <summary>
    /// Based on the question type, finds the correct answer(s) and resubmits the quiz.
    /// Note: This sets the number of attempts to -1 which represents the user clicked ShowAnswer.
    /// </summary>
    private void ShowAnswer()
    {
        this._options.ForEach(option => option.IsChecked = option.IsCorrect);
        this.SelectedOption = this._options.First(option => option.IsCorrect).Text;
        // We had to move this line above so that the submit method can know when the user clicked "show answer" and then award xp accordingly. 
        this.attempts = -1;
        this.Submit();
    }

    private void UpdateAndSave()
    {
        this._options.ForEach(option => option.UpdateAndSave());
    }
}